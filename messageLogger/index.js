(function(u,t,o,f,a,p,T,E,m,l){"use strict";const{ScrollView:D,View:S,Text:g}=t.ReactNative,{FormDivider:N}=E.Forms,v=o.findByStoreName("ChannelStore"),c=t.stylesheet.createThemedStyleSheet({container:{flex:1,backgroundColor:l.semanticColors.BACKGROUND_PRIMARY},logEntry:{padding:16},author:{color:l.semanticColors.HEADER_PRIMARY,fontWeight:"bold",marginBottom:4},content:{color:l.semanticColors.TEXT_NORMAL},timestamp:{color:l.semanticColors.TEXT_MUTED,fontSize:12,marginTop:4},emptyState:{color:l.semanticColors.TEXT_MUTED,textAlign:"center",marginTop:20}});function I({channelId:n}){const e=v.getChannel(n),s=a.storage.deletedMessages?.[n]??[];return t.React.createElement(D,{style:c.container},s.length>0?s.map(function(r,i){return t.React.createElement(t.React.Fragment,{key:r.id+i},t.React.createElement(S,{style:c.logEntry},t.React.createElement(g,{style:c.author},r.author),t.React.createElement(g,{style:c.content},r.content),t.React.createElement(g,{style:c.timestamp},"Deleted at: ",new Date(r.deletedTimestamp).toLocaleString())),t.React.createElement(N,null))}):t.React.createElement(g,{style:c.emptyState},"No deleted messages logged for #",e?.name,"."))}const{TouchableOpacity:b,View:w}=E.General,B=o.findByStoreName("ChannelStore");let h,y,C;const M=2*24*60*60*1e3;a.storage.messageCache??={},a.storage.deletedMessages??={};const d=[];function L(){const n=Date.now();Object.keys(a.storage.messageCache).forEach(function(e){n-a.storage.messageCache[e].timestamp>M&&delete a.storage.messageCache[e]}),Object.keys(a.storage.deletedMessages).forEach(function(e){a.storage.deletedMessages[e]=a.storage.deletedMessages[e].filter(function(s){return n-new Date(s.deletedTimestamp).getTime()<M})})}function A(n){if(!n?.id||!n.content||n.author?.bot)return;const e=a.storage.messageCache[n.id];a.storage.messageCache[n.id]={content:n.content,author:n.author?.username??"unknown",timestamp:Date.now(),editHistory:e?.editHistory??[]}}function _({channelId:n,channelName:e}){h??=o.findByProps("push","pushLazy","pop"),y??=o.findByName("Navigator")??o.findByProps("Navigator")?.Navigator,C??=o.findByProps("getRenderCloseButton")?.getRenderCloseButton;const s=function(){if(!h)return m.showToast("ML Error: Navigation module not found!");if(!y)return m.showToast("ML Error: Navigator component not found!");if(!C)return m.showToast("ML Error: getRenderCloseButton not found!");const r=function(){return t.React.createElement(y,{initialRouteName:"DeletedMessagesLog",screens:{DeletedMessagesLog:{title:`Deleted Msgs in #${e}`,headerLeft:C(function(){return h.pop()}),render:function(){return t.React.createElement(I,{channelId:n})}}}})};h.push(r)};return t.React.createElement(b,{onPress:s,style:{position:"absolute",right:50,top:13,zIndex:1}},t.React.createElement(E.Forms.FormIcon,{source:T.getAssetIDByName("ic_trash_24px")}))}var x={onLoad:function(){L(),d.push(t.FluxDispatcher.subscribe("MESSAGE_CREATE",function({message:e}){return A(e)})),d.push(t.FluxDispatcher.subscribe("MESSAGE_UPDATE",function({message:e}){const s=a.storage.messageCache[e.id];if(s&&e.content&&s.content!==e.content){const r=s.editHistory??[];r.push({content:s.content,timestamp:s.timestamp}),a.storage.messageCache[e.id]={...s,content:e.content,timestamp:Date.now(),editHistory:r}}})),d.push(t.FluxDispatcher.subscribe("MESSAGE_DELETE",function(e){const s=a.storage.messageCache[e.id];s&&(a.storage.deletedMessages[e.channelId]??=[],a.storage.deletedMessages[e.channelId].unshift({id:e.id,content:s.content,author:s.author,deletedTimestamp:new Date().toISOString()}),a.storage.deletedMessages[e.channelId].length>100&&a.storage.deletedMessages[e.channelId].pop(),delete a.storage.messageCache[e.id])}));const n=o.findByName("ChannelHeader",!1);n?d.push(p.instead("default",n,function(e,s){const r=s(...e),i=e[0]?.channelId;if(!i)return r;const R=B.getChannel(i);return!R||!(a.storage.deletedMessages[i]?.length>0)?r:t.React.createElement(w,{style:{flex:1}},r,t.React.createElement(_,{channelId:i,channelName:R.name}))})):f.logger.error("MessageLogger: Could not find ChannelHeader component"),f.logger.log("MessageLogger loaded with UI.")},onUnload:function(){d.forEach(function(n){return n?.()}),d.length=0,f.logger.log("MessageLogger unloaded.")}};return u.default=x,Object.defineProperty(u,"__esModule",{value:!0}),u})({},vendetta.metro.common,vendetta.metro,vendetta,vendetta.plugin,vendetta.patcher,vendetta.ui.assets,vendetta.ui.components,vendetta.ui.toasts,vendetta.ui);
