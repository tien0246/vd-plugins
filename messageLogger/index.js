(function(u,t,o,f,a,T,D,E,c){"use strict";const{ScrollView:S,View:I,Text:g}=t.ReactNative,{FormDivider:B}=E.Forms,b=o.findByStoreName("ChannelStore"),A=o.findByProps("parse","parseTopic"),d=t.stylesheet.createThemedStyleSheet({container:{flex:1,backgroundColor:c.semanticColors.BACKGROUND_PRIMARY},logEntry:{padding:16},author:{color:c.semanticColors.HEADER_PRIMARY,fontWeight:"bold",marginBottom:4},contentContainer:{},timestamp:{color:c.semanticColors.TEXT_MUTED,fontSize:12,marginTop:4},emptyState:{color:c.semanticColors.TEXT_MUTED,textAlign:"center",marginTop:20}});function N({channelId:s}){const e=b.getChannel(s),n=a.storage.deletedMessages?.[s]??[];return t.React.createElement(S,{style:d.container},n.length>0?n.map(function(r,l){return t.React.createElement(t.React.Fragment,{key:r.id+l},t.React.createElement(I,{style:d.logEntry},t.React.createElement(g,{style:d.author},r.author),t.React.createElement(g,{style:d.contentContainer},A.parse(r.content,!0,{channelId:s})),t.React.createElement(g,{style:d.timestamp},"Deleted at: ",new Date(r.deletedTimestamp).toLocaleString())),t.React.createElement(B,null))}):t.React.createElement(g,{style:d.emptyState},"No deleted messages logged for #",e?.name,"."))}const{TouchableOpacity:v,View:m}=E.General,L=o.findByStoreName("ChannelStore");let h,C,y;const R=2*24*60*60*1e3;a.storage.messageCache??={},a.storage.deletedMessages??={};const i=[],M=t.stylesheet.createThemedStyleSheet({iconContainer:{width:30,height:30,borderRadius:15,backgroundColor:c.semanticColors.BACKGROUND_MODIFIER_ACCENT,justifyContent:"center",alignItems:"center"},icon:{tintColor:c.semanticColors.INTERACTIVE_NORMAL}});function _(){const s=Date.now();Object.keys(a.storage.messageCache).forEach(function(e){s-a.storage.messageCache[e].timestamp>R&&delete a.storage.messageCache[e]}),Object.keys(a.storage.deletedMessages).forEach(function(e){a.storage.deletedMessages[e]=a.storage.deletedMessages[e].filter(function(n){return s-new Date(n.deletedTimestamp).getTime()<R}),a.storage.deletedMessages[e].length===0&&delete a.storage.deletedMessages[e]})}function w(s){if(!s?.id||!s.content||s.author?.bot)return;const e=a.storage.messageCache[s.id];a.storage.messageCache[s.id]={content:s.content,author:s.author?.username??"unknown",timestamp:Date.now(),editHistory:e?.editHistory??[]}}function F({channel:s}){h??=o.findByProps("push","pushLazy","pop"),C??=o.findByName("Navigator")??o.findByProps("Navigator")?.Navigator,y??=o.findByProps("getRenderCloseButton")?.getRenderCloseButton??o.findByProps("getHeaderCloseButton")?.getHeaderCloseButton;const e=function(){if(!h||!C||!y)return f.logger.error("MessageLogger: Failed to get navigation modules.");const n=function(){return t.React.createElement(C,{initialRouteName:"DeletedMessagesLog",screens:{DeletedMessagesLog:{title:`Deleted Msgs in #${s.name}`,headerLeft:y(function(){return h.pop()}),render:function(){return t.React.createElement(N,{channelId:s.id})}}}})};h.push(n)};return t.React.createElement(v,{onPress:e,style:{position:"absolute",right:16,top:14,zIndex:1}},t.React.createElement(m,{style:M.iconContainer},t.React.createElement(E.Forms.FormIcon,{style:M.icon,source:D.getAssetIDByName("ic_trash_24px")})))}var H={onLoad:function(){_(),i.push(t.FluxDispatcher.subscribe("MESSAGE_CREATE",function({message:e}){return w(e)})),i.push(t.FluxDispatcher.subscribe("MESSAGE_UPDATE",function({message:e}){const n=a.storage.messageCache[e.id];if(n&&e.content&&n.content!==e.content){const r=n.editHistory??[];r.push({content:n.content,timestamp:n.timestamp}),a.storage.messageCache[e.id]={...n,content:e.content,timestamp:Date.now(),editHistory:r}}})),i.push(t.FluxDispatcher.subscribe("MESSAGE_DELETE",function(e){const n=a.storage.messageCache[e.id];n&&(a.storage.deletedMessages[e.channelId]??=[],a.storage.deletedMessages[e.channelId].unshift({id:e.id,content:n.content,author:n.author,deletedTimestamp:new Date().toISOString()}),a.storage.deletedMessages[e.channelId].length>100&&a.storage.deletedMessages[e.channelId].pop(),delete a.storage.messageCache[e.id])}));const s=o.findByName("ChannelHeader",!1);s?i.push(T.instead("default",s,function(e,n){const r=n(...e),l=e[0]?.channelId;if(!l)return r;const p=L.getChannel(l);return!p||!(a.storage.deletedMessages[l]?.length>0)?r:t.React.createElement(m,{style:{flex:1}},r,t.React.createElement(F,{channel:p}))})):f.logger.error("MessageLogger: Could not find ChannelHeader component")},onUnload:function(){i.forEach(function(s){return s?.()}),i.length=0,f.logger.log("MessageLogger unloaded.")}};return u.default=H,Object.defineProperty(u,"__esModule",{value:!0}),u})({},vendetta.metro.common,vendetta.metro,vendetta,vendetta.plugin,vendetta.patcher,vendetta.ui.assets,vendetta.ui.components,vendetta.ui);
