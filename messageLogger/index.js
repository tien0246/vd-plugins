(function(f,n,d,p,m,t,R,T,C,g,i){"use strict";const{ScrollView:M,View:S,Text:u}=g.General,{FormRow:H,FormDivider:D}=g.Forms,A=d.findByStoreName("ChannelStore"),o=n.stylesheet.createThemedStyleSheet({container:{flex:1,backgroundColor:i.semanticColors.BACKGROUND_PRIMARY},logEntry:{padding:16},author:{color:i.semanticColors.HEADER_PRIMARY,fontWeight:"bold",marginBottom:4},content:{color:i.semanticColors.TEXT_NORMAL},timestamp:{color:i.semanticColors.TEXT_MUTED,fontSize:12,marginTop:4},emptyState:{color:i.semanticColors.TEXT_MUTED,textAlign:"center",marginTop:20}});function b({channelId:s}){const e=A.getChannel(s),a=t.storage.deletedMessages?.[s]??[];return n.React.createElement(M,{style:o.container},a.length>0?a.map(function(r,l){return n.React.createElement(n.React.Fragment,{key:r.id+l},n.React.createElement(S,{style:o.logEntry},n.React.createElement(u,{style:o.author},r.author),n.React.createElement(u,{style:o.content},r.content),n.React.createElement(u,{style:o.timestamp},"Deleted at: ",new Date(r.deletedTimestamp).toLocaleString())),n.React.createElement(D,null))}):n.React.createElement(u,{style:o.emptyState},"No deleted messages logged for #",e?.name,"."))}const{TouchableOpacity:w}=g.General;d.findByProps("openLazy","hideActionSheet"),d.findByProps("ActionSheetRow");const v=d.findByProps("push","pop"),y=2*24*60*60*1e3;t.storage.messageCache??={},t.storage.deletedMessages??={};const c=[];function _(){const s=Date.now();Object.keys(t.storage.messageCache).forEach(function(e){s-t.storage.messageCache[e].timestamp>y&&delete t.storage.messageCache[e]}),Object.keys(t.storage.deletedMessages).forEach(function(e){t.storage.deletedMessages[e]=t.storage.deletedMessages[e].filter(function(a){return s-new Date(a.deletedTimestamp).getTime()<y})})}function I(s){if(!s?.id||!s.content||s.author?.bot)return;const e=t.storage.messageCache[s.id];t.storage.messageCache[s.id]={content:s.content,author:s.author?.username??"unknown",timestamp:Date.now(),editHistory:e?.editHistory??[]}}var P={onLoad:function(){_(),c.push(n.FluxDispatcher.subscribe("MESSAGE_CREATE",function({message:e}){return I(e)})),c.push(n.FluxDispatcher.subscribe("MESSAGE_UPDATE",function({message:e}){const a=t.storage.messageCache[e.id];if(a&&e.content&&a.content!==a.content){const r=a.editHistory??[];r.push({content:a.content,timestamp:a.timestamp}),t.storage.messageCache[e.id]={...a,content:e.content,timestamp:Date.now(),editHistory:r}}})),c.push(n.FluxDispatcher.subscribe("MESSAGE_DELETE",function(e){const a=t.storage.messageCache[e.id];if(a){const{channelId:r}=e;t.storage.deletedMessages[r]??=[],t.storage.deletedMessages[r].unshift({id:e.id,content:a.content,author:a.author,deletedTimestamp:new Date().toISOString()}),t.storage.deletedMessages[r].length>100&&t.storage.deletedMessages[r].pop(),delete t.storage.messageCache[e.id]}}));const s=d.findByName("ChannelHeader",!1);s&&c.push(R.after("default",s,function(e,a){const r=Object.keys(e[0]??{}).join(", ");p.showToast(`CH Props keys: ${r}`);const l=e[0]?.channel;if(!l)return;const E=l.id;if(!(t.storage.deletedMessages[E]?.length>0))return;const h=T.findInReactTree(a,function(F){return F?.type?.name==="HeaderTitle"});h?.props?.children&&(Array.isArray(h.props.children)||(h.props.children=[h.props.children]),h.props.children.push(n.React.createElement(w,{onPress:function(){v.push("VendettaCustomPage",{title:`Deleted Msgs in #${l.name}`,render:function(){return n.React.createElement(b,{channelId:E})}})},style:{marginRight:8}},n.React.createElement(g.Forms.FormIcon,{source:C.getAssetIDByName("ic_trash_24px")}))))})),m.logger.log("MessageLogger loaded with UI.")},onUnload:function(){c.forEach(function(s){return s?.()}),c.length=0,m.logger.log("MessageLogger unloaded.")}};return f.default=P,Object.defineProperty(f,"__esModule",{value:!0}),f})({},vendetta.metro.common,vendetta.metro,vendetta.ui.toasts,vendetta,vendetta.plugin,vendetta.patcher,vendetta.utils,vendetta.ui.assets,vendetta.ui.components,vendetta.ui);
