(function(g,t,h,u,a,y,C,m,l){"use strict";const{ScrollView:M,View:R,Text:i}=t.ReactNative,{FormDivider:T}=m.Forms,D=h.findByStoreName("ChannelStore"),o=t.stylesheet.createThemedStyleSheet({container:{flex:1,backgroundColor:l.semanticColors.BACKGROUND_PRIMARY},logEntry:{padding:16},author:{color:l.semanticColors.HEADER_PRIMARY,fontWeight:"bold",marginBottom:4},content:{color:l.semanticColors.TEXT_NORMAL},timestamp:{color:l.semanticColors.TEXT_MUTED,fontSize:12,marginTop:4},emptyState:{color:l.semanticColors.TEXT_MUTED,textAlign:"center",marginTop:20}});function S({channelId:s}){const e=D.getChannel(s),n=a.storage.deletedMessages?.[s]??[];return t.React.createElement(M,{style:o.container},n.length>0?n.map(function(r,d){return t.React.createElement(t.React.Fragment,{key:r.id+d},t.React.createElement(R,{style:o.logEntry},t.React.createElement(i,{style:o.author},r.author),t.React.createElement(i,{style:o.content},r.content),t.React.createElement(i,{style:o.timestamp},"Deleted at: ",new Date(r.deletedTimestamp).toLocaleString())),t.React.createElement(T,null))}):t.React.createElement(i,{style:o.emptyState},"No deleted messages logged for #",e?.name,"."))}const{TouchableOpacity:I,View:b}=m.General,p=h.findByStoreName("ChannelStore"),f=2*24*60*60*1e3;a.storage.messageCache??={},a.storage.deletedMessages??={};const c=[];function v(){const s=Date.now();Object.keys(a.storage.messageCache).forEach(function(e){s-a.storage.messageCache[e].timestamp>f&&delete a.storage.messageCache[e]}),Object.keys(a.storage.deletedMessages).forEach(function(e){a.storage.deletedMessages[e]=a.storage.deletedMessages[e].filter(function(n){return s-new Date(n.deletedTimestamp).getTime()<f})})}function N(s){if(!s?.id||!s.content||s.author?.bot)return;const e=a.storage.messageCache[s.id];a.storage.messageCache[s.id]={content:s.content,author:s.author?.username??"unknown",timestamp:Date.now(),editHistory:e?.editHistory??[]}}function w({channelId:s,channelName:e}){const n=t.NavigationNative.useNavigation();return t.React.createElement(I,{onPress:function(){n.push("VendettaCustomPage",{title:`Deleted Msgs in #${e}`,render:function(){return t.React.createElement(S,{channelId:s})}})},style:{position:"absolute",right:50,top:13,zIndex:1}},t.React.createElement(m.Forms.FormIcon,{source:C.getAssetIDByName("ic_trash_24px")}))}var A={onLoad:function(){v(),c.push(t.FluxDispatcher.subscribe("MESSAGE_CREATE",function({message:e}){return N(e)})),c.push(t.FluxDispatcher.subscribe("MESSAGE_UPDATE",function({message:e}){const n=a.storage.messageCache[e.id];if(n&&e.content&&n.content!==e.content){const r=n.editHistory??[];r.push({content:n.content,timestamp:n.timestamp}),a.storage.messageCache[e.id]={...n,content:e.content,timestamp:Date.now(),editHistory:r}}})),c.push(t.FluxDispatcher.subscribe("MESSAGE_DELETE",function(e){const n=a.storage.messageCache[e.id];n&&(a.storage.deletedMessages[e.channelId]??=[],a.storage.deletedMessages[e.channelId].unshift({id:e.id,content:n.content,author:n.author,deletedTimestamp:new Date().toISOString()}),a.storage.deletedMessages[e.channelId].length>100&&a.storage.deletedMessages[e.channelId].pop(),delete a.storage.messageCache[e.id])}));const s=h.findByName("ChannelHeader",!1);s?c.push(y.instead("default",s,function(e,n){const r=n(...e),d=e[0]?.channelId;if(!d)return r;const E=p.getChannel(d);return!E||!(a.storage.deletedMessages[d]?.length>0)?r:t.React.createElement(b,{style:{flex:1}},r,t.React.createElement(w,{channelId:d,channelName:E.name}))})):u.logger.error("MessageLogger: Could not find ChannelHeader component"),u.logger.log("MessageLogger loaded with UI.")},onUnload:function(){c.forEach(function(s){return s?.()}),c.length=0,u.logger.log("MessageLogger unloaded.")}};return g.default=A,Object.defineProperty(g,"__esModule",{value:!0}),g})({},vendetta.metro.common,vendetta.metro,vendetta,vendetta.plugin,vendetta.patcher,vendetta.ui.assets,vendetta.ui.components,vendetta.ui);
