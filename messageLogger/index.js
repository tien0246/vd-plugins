(function(u,s,o,f,t,y,C,l,i){"use strict";const{ScrollView:p,View:R,Text:g}=l.General,{FormRow:v,FormDivider:M}=l.Forms,S=o.findByStoreName("ChannelStore"),c=s.stylesheet.createThemedStyleSheet({container:{flex:1,backgroundColor:i.semanticColors.BACKGROUND_PRIMARY},logEntry:{padding:16},author:{color:i.semanticColors.HEADER_PRIMARY,fontWeight:"bold",marginBottom:4},content:{color:i.semanticColors.TEXT_NORMAL},timestamp:{color:i.semanticColors.TEXT_MUTED,fontSize:12,marginTop:4},emptyState:{color:i.semanticColors.TEXT_MUTED,textAlign:"center",marginTop:20}});function T({channelId:n}){const e=S.getChannel(n),a=t.storage.deletedMessages?.[n]??[];return s.React.createElement(p,{style:c.container},a.length>0?a.map(function(r,h){return s.React.createElement(s.React.Fragment,{key:r.id+h},s.React.createElement(R,{style:c.logEntry},s.React.createElement(g,{style:c.author},r.author),s.React.createElement(g,{style:c.content},r.content),s.React.createElement(g,{style:c.timestamp},"Deleted at: ",new Date(r.deletedTimestamp).toLocaleString())),s.React.createElement(M,null))}):s.React.createElement(g,{style:c.emptyState},"No deleted messages logged for #",e?.name,"."))}const{TouchableOpacity:D}=l.General;o.findByProps("openLazy","hideActionSheet"),o.findByProps("ActionSheetRow");const A=o.findByProps("push","pop"),b=o.findByStoreName("ChannelStore"),m=2*24*60*60*1e3;t.storage.messageCache??={},t.storage.deletedMessages??={};const d=[];function w(){const n=Date.now();Object.keys(t.storage.messageCache).forEach(function(e){n-t.storage.messageCache[e].timestamp>m&&delete t.storage.messageCache[e]}),Object.keys(t.storage.deletedMessages).forEach(function(e){t.storage.deletedMessages[e]=t.storage.deletedMessages[e].filter(function(a){return n-new Date(a.deletedTimestamp).getTime()<m})})}function I(n){if(!n?.id||!n.content||n.author?.bot)return;const e=t.storage.messageCache[n.id];t.storage.messageCache[n.id]={content:n.content,author:n.author?.username??"unknown",timestamp:Date.now(),editHistory:e?.editHistory??[]}}var F={onLoad:function(){w(),d.push(s.FluxDispatcher.subscribe("MESSAGE_CREATE",function({message:e}){return I(e)})),d.push(s.FluxDispatcher.subscribe("MESSAGE_UPDATE",function({message:e}){const a=t.storage.messageCache[e.id];if(a&&e.content&&a.content!==a.content){const r=a.editHistory??[];r.push({content:a.content,timestamp:a.timestamp}),t.storage.messageCache[e.id]={...a,content:e.content,timestamp:Date.now(),editHistory:r}}})),d.push(s.FluxDispatcher.subscribe("MESSAGE_DELETE",function(e){const a=t.storage.messageCache[e.id];if(a){const{channelId:r}=e;t.storage.deletedMessages[r]??=[],t.storage.deletedMessages[r].unshift({id:e.id,content:a.content,author:a.author,deletedTimestamp:new Date().toISOString()}),t.storage.deletedMessages[r].length>100&&t.storage.deletedMessages[r].pop(),delete t.storage.messageCache[e.id]}}));const n=o.findByName("ChannelHeader",!1);n?d.push(y.after("default",n,function(e,a){const r=e[0]?.channelId;if(!r)return;const h=b.getChannel(r);if(!h||!(t.storage.deletedMessages[r]?.length>0))return;const E=a?.props?.children;if(!E)return;const _=s.React.createElement(D,{onPress:function(){A.push("VendettaCustomPage",{title:`Deleted Msgs in #${h.name}`,render:function(){return s.React.createElement(T,{channelId:r})}})},style:{position:"absolute",right:12,top:12,zIndex:1}},s.React.createElement(l.Forms.FormIcon,{source:C.getAssetIDByName("ic_trash_24px")}));a.props.children=s.React.createElement(s.React.Fragment,null,E,_)})):f.logger.error("MessageLogger: Could not find ChannelHeader component"),f.logger.log("MessageLogger loaded with UI.")},onUnload:function(){d.forEach(function(n){return n?.()}),d.length=0,f.logger.log("MessageLogger unloaded.")}};return u.default=F,Object.defineProperty(u,"__esModule",{value:!0}),u})({},vendetta.metro.common,vendetta.metro,vendetta,vendetta.plugin,vendetta.patcher,vendetta.ui.assets,vendetta.ui.components,vendetta.ui);
