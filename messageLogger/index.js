(function(l,o,d,g,n,E,M,u,C){"use strict";const{openAlert:y}=d.findByProps("openAlert","dismissAlert"),{AlertModal:m,AlertActionButton:h}=d.findByProps("AlertModal","AlertActions"),{Stack:A,TextInput:B}=d.findByProps("Stack");function p(t){m&&h?D(t):C.showConfirmationAlert(t)}function D({title:t,content:e,placeholder:a,confirmText:s,cancelText:r,onConfirm:i}){y(I(t),React.createElement(m,{title:t,content:e,actions:React.createElement(A,null,React.createElement(h,{text:s,variant:"primary",onPress:i}),r?React.createElement(h,{text:r,variant:"secondary"}):React.createElement(React.Fragment,null))}))}function I(t){return`vdarnfg-${t?.toLowerCase?.().replaceAll?.(" ","-")}`}const{TouchableOpacity:S,View:b}=u.General,T=d.findByStoreName("ChannelStore"),f=2*24*60*60*1e3;n.storage.messageCache??={},n.storage.deletedMessages??={};const c=[];function w(){const t=Date.now();Object.keys(n.storage.messageCache).forEach(function(e){t-n.storage.messageCache[e].timestamp>f&&delete n.storage.messageCache[e]}),Object.keys(n.storage.deletedMessages).forEach(function(e){n.storage.deletedMessages[e]=n.storage.deletedMessages[e].filter(function(a){return t-new Date(a.deletedTimestamp).getTime()<f})})}function x(t){if(!t?.id||!t.content||t.author?.bot)return;const e=n.storage.messageCache[t.id];n.storage.messageCache[t.id]={content:t.content,author:t.author?.username??"unknown",timestamp:Date.now(),editHistory:e?.editHistory??[]}}function v({channelId:t,channelName:e}){return o.React.createElement(S,{onPress:function(){const a=(n.storage.deletedMessages?.[t]??[]).slice(0,10).map(function(s){return`[${new Date(s.deletedTimestamp).toLocaleTimeString()}] ${s.author}: ${s.content}`}).join(`

`);p({title:`Deleted Msgs in #${e}`,content:a||"No deleted messages logged.",confirmText:"Close"})},style:{position:"absolute",right:50,top:13,zIndex:1}},o.React.createElement(u.Forms.FormIcon,{source:M.getAssetIDByName("ic_trash_24px")}))}var R={onLoad:function(){w(),c.push(o.FluxDispatcher.subscribe("MESSAGE_CREATE",function({message:e}){return x(e)})),c.push(o.FluxDispatcher.subscribe("MESSAGE_UPDATE",function({message:e}){const a=n.storage.messageCache[e.id];if(a&&e.content&&a.content!==e.content){const s=a.editHistory??[];s.push({content:a.content,timestamp:a.timestamp}),n.storage.messageCache[e.id]={...a,content:e.content,timestamp:Date.now(),editHistory:s}}})),c.push(o.FluxDispatcher.subscribe("MESSAGE_DELETE",function(e){const a=n.storage.messageCache[e.id];a&&(n.storage.deletedMessages[e.channelId]??=[],n.storage.deletedMessages[e.channelId].unshift({id:e.id,content:a.content,author:a.author,deletedTimestamp:new Date().toISOString()}),n.storage.deletedMessages[e.channelId].length>100&&n.storage.deletedMessages[e.channelId].pop(),delete n.storage.messageCache[e.id])}));const t=d.findByName("ChannelHeader",!1);t?c.push(E.instead("default",t,function(e,a){const s=a(...e),r=e[0]?.channelId;if(!r)return s;const i=T.getChannel(r);return!i||!(n.storage.deletedMessages[r]?.length>0)?s:o.React.createElement(b,{style:{flex:1}},s,o.React.createElement(v,{channelId:r,channelName:i.name}))})):g.logger.error("MessageLogger: Could not find ChannelHeader component"),g.logger.log("MessageLogger loaded with UI.")},onUnload:function(){c.forEach(function(t){return t?.()}),c.length=0,g.logger.log("MessageLogger unloaded.")}};return l.default=R,Object.defineProperty(l,"__esModule",{value:!0}),l})({},vendetta.metro.common,vendetta.metro,vendetta,vendetta.plugin,vendetta.patcher,vendetta.ui.assets,vendetta.ui.components,vendetta.ui.alerts);
