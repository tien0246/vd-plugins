(function(u,n,i,m,t,E,y,p,g,l){"use strict";const{ScrollView:R,View:T,Text:h}=g.General,{FormRow:I,FormDivider:C}=g.Forms,M=i.findByStoreName("ChannelStore"),c=n.stylesheet.createThemedStyleSheet({container:{flex:1,backgroundColor:l.semanticColors.BACKGROUND_PRIMARY},logEntry:{padding:16},author:{color:l.semanticColors.HEADER_PRIMARY,fontWeight:"bold",marginBottom:4},content:{color:l.semanticColors.TEXT_NORMAL},timestamp:{color:l.semanticColors.TEXT_MUTED,fontSize:12,marginTop:4},emptyState:{color:l.semanticColors.TEXT_MUTED,textAlign:"center",marginTop:20}});function D({channelId:a}){const e=M.getChannel(a),s=t.storage.deletedMessages?.[a]??[];return n.React.createElement(R,{style:c.container},s.length>0?s.map(function(r,o){return n.React.createElement(n.React.Fragment,{key:r.id+o},n.React.createElement(T,{style:c.logEntry},n.React.createElement(h,{style:c.author},r.author),n.React.createElement(h,{style:c.content},r.content),n.React.createElement(h,{style:c.timestamp},"Deleted at: ",new Date(r.deletedTimestamp).toLocaleString())),n.React.createElement(C,null))}):n.React.createElement(h,{style:c.emptyState},"No deleted messages logged for #",e?.name,"."))}const{TouchableOpacity:S}=g.General;i.findByProps("openLazy","hideActionSheet"),i.findByProps("ActionSheetRow");const A=i.findByProps("push","pop"),f=2*24*60*60*1e3;t.storage.messageCache??={},t.storage.deletedMessages??={};const d=[];function b(){const a=Date.now();Object.keys(t.storage.messageCache).forEach(function(e){a-t.storage.messageCache[e].timestamp>f&&delete t.storage.messageCache[e]}),Object.keys(t.storage.deletedMessages).forEach(function(e){t.storage.deletedMessages[e]=t.storage.deletedMessages[e].filter(function(s){return a-new Date(s.deletedTimestamp).getTime()<f})})}function w(a){if(!a?.id||!a.content||a.author?.bot)return;const e=t.storage.messageCache[a.id];t.storage.messageCache[a.id]={content:a.content,author:a.author?.username??"unknown",timestamp:Date.now(),editHistory:e?.editHistory??[]}}var v={onLoad:function(){b(),d.push(n.FluxDispatcher.subscribe("MESSAGE_CREATE",function({message:e}){return w(e)})),d.push(n.FluxDispatcher.subscribe("MESSAGE_UPDATE",function({message:e}){const s=t.storage.messageCache[e.id];if(s&&e.content&&s.content!==s.content){const r=s.editHistory??[];r.push({content:s.content,timestamp:s.timestamp}),t.storage.messageCache[e.id]={...s,content:e.content,timestamp:Date.now(),editHistory:r}}})),d.push(n.FluxDispatcher.subscribe("MESSAGE_DELETE",function(e){const s=t.storage.messageCache[e.id];if(s){const{channelId:r}=e;t.storage.deletedMessages[r]??=[],t.storage.deletedMessages[r].unshift({id:e.id,content:s.content,author:s.author,deletedTimestamp:new Date().toISOString()}),t.storage.deletedMessages[r].length>100&&t.storage.deletedMessages[r].pop(),delete t.storage.messageCache[e.id]}}));const a=i.findByName("ChannelHeader",!1);a&&d.push(E.after("default",a,function([{channel:e}],s){const r=e.id;if(!(t.storage.deletedMessages[r]?.length>0))return;const o=y.findInReactTree(s,function(_){return _?.type?.name==="HeaderTitle"});o?.props?.children&&(Array.isArray(o.props.children)||(o.props.children=[o.props.children]),o.props.children.push(n.React.createElement(S,{onPress:function(){A.push("VendettaCustomPage",{title:`Deleted Msgs in #${e.name}`,render:function(){return n.React.createElement(D,{channelId:r})}})},style:{marginRight:8}},n.React.createElement(g.Forms.FormIcon,{source:p.getAssetIDByName("ic_trash_24px")}))))})),m.logger.log("MessageLogger loaded with UI.")},onUnload:function(){d.forEach(function(a){return a?.()}),d.length=0,m.logger.log("MessageLogger unloaded.")}};return u.default=v,Object.defineProperty(u,"__esModule",{value:!0}),u})({},vendetta.metro.common,vendetta.metro,vendetta,vendetta.plugin,vendetta.patcher,vendetta.utils,vendetta.ui.assets,vendetta.ui.components,vendetta.ui);
