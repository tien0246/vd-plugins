(function(i,s,u,g,t,f,E,h,y,d){"use strict";const{ScrollView:C,View:M,Text:l}=s.ReactNative,{FormDivider:R}=h.Forms,T=u.findByStoreName("ChannelStore"),o=s.stylesheet.createThemedStyleSheet({container:{flex:1,backgroundColor:d.semanticColors.BACKGROUND_PRIMARY},logEntry:{padding:16},author:{color:d.semanticColors.HEADER_PRIMARY,fontWeight:"bold",marginBottom:4},content:{color:d.semanticColors.TEXT_NORMAL},timestamp:{color:d.semanticColors.TEXT_MUTED,fontSize:12,marginTop:4},emptyState:{color:d.semanticColors.TEXT_MUTED,textAlign:"center",marginTop:20}});function D({channelId:a}){const e=T.getChannel(a),n=t.storage.deletedMessages?.[a]??[];return s.React.createElement(C,{style:o.container},n.length>0?n.map(function(r,I){return s.React.createElement(s.React.Fragment,{key:r.id+I},s.React.createElement(M,{style:o.logEntry},s.React.createElement(l,{style:o.author},r.author),s.React.createElement(l,{style:o.content},r.content),s.React.createElement(l,{style:o.timestamp},"Deleted at: ",new Date(r.deletedTimestamp).toLocaleString())),s.React.createElement(R,null))}):s.React.createElement(l,{style:o.emptyState},"No deleted messages logged for #",e?.name,"."))}const{TouchableOpacity:S}=h.General,m=2*24*60*60*1e3;t.storage.messageCache??={},t.storage.deletedMessages??={};const c=[];function v(){const a=Date.now();Object.keys(t.storage.messageCache).forEach(function(e){a-t.storage.messageCache[e].timestamp>m&&delete t.storage.messageCache[e]}),Object.keys(t.storage.deletedMessages).forEach(function(e){t.storage.deletedMessages[e]=t.storage.deletedMessages[e].filter(function(n){return a-new Date(n.deletedTimestamp).getTime()<m}),t.storage.deletedMessages[e].length===0&&delete t.storage.deletedMessages[e]})}function A(a){if(!a?.id||!a.content||a.author?.bot)return;const e=t.storage.messageCache[a.id];t.storage.messageCache[a.id]={content:a.content,author:a.author?.username??"unknown",timestamp:Date.now(),editHistory:e?.editHistory??[]}}function b({channel:a}){y.useProxy(t.storage);const e=s.NavigationNative.useNavigation();return t.storage.deletedMessages[a.id]?.length>0?s.React.createElement(S,{onPress:function(){e.push("VendettaCustomPage",{title:`Deleted Msgs in #${a.name}`,render:function(){return s.React.createElement(D,{channelId:a.id})}})}},s.React.createElement(h.Forms.FormIcon,{style:{marginRight:16},source:E.getAssetIDByName("ic_trash_24px")})):null}var p={onLoad:function(){v(),c.push(s.FluxDispatcher.subscribe("MESSAGE_CREATE",function({message:e}){return A(e)})),c.push(s.FluxDispatcher.subscribe("MESSAGE_UPDATE",function({message:e}){const n=t.storage.messageCache[e.id];if(n&&e.content&&n.content!==e.content){const r=n.editHistory??[];r.push({content:n.content,timestamp:n.timestamp}),t.storage.messageCache[e.id]={...n,content:e.content,timestamp:Date.now(),editHistory:r}}})),c.push(s.FluxDispatcher.subscribe("MESSAGE_DELETE",function(e){const n=t.storage.messageCache[e.id];n&&(t.storage.deletedMessages[e.channelId]??=[],t.storage.deletedMessages[e.channelId].unshift({id:e.id,content:n.content,author:n.author,deletedTimestamp:new Date().toISOString()}),t.storage.deletedMessages[e.channelId].length>100&&t.storage.deletedMessages[e.channelId].pop(),delete t.storage.messageCache[e.id])}));const a=u.findByName("ChannelButtons",!1);a?c.push(f.after("default",a,function([{channel:e}],n){!e||!Array.isArray(n?.props?.children)||n.props.children.unshift(s.React.createElement(b,{channel:e}))})):g.logger.error("MessageLogger: Could not find ChannelButtons component"),g.logger.log("MessageLogger v1.0.0 loaded.")},onUnload:function(){c.forEach(function(a){return a?.()}),c.length=0,g.logger.log("MessageLogger unloaded.")}};return i.default=p,Object.defineProperty(i,"__esModule",{value:!0}),i})({},vendetta.metro.common,vendetta.metro,vendetta,vendetta.plugin,vendetta.patcher,vendetta.ui.assets,vendetta.ui.components,vendetta.storage,vendetta.ui);
