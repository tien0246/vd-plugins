(function(m,r,c,o,p,t,C,T,M,u,l){"use strict";const{ScrollView:R,View:D,Text:f}=u.General,{FormRow:B,FormDivider:S}=u.Forms,w=c.findByStoreName("ChannelStore"),d=r.stylesheet.createThemedStyleSheet({container:{flex:1,backgroundColor:l.semanticColors.BACKGROUND_PRIMARY},logEntry:{padding:16},author:{color:l.semanticColors.HEADER_PRIMARY,fontWeight:"bold",marginBottom:4},content:{color:l.semanticColors.TEXT_NORMAL},timestamp:{color:l.semanticColors.TEXT_MUTED,fontSize:12,marginTop:4},emptyState:{color:l.semanticColors.TEXT_MUTED,textAlign:"center",marginTop:20}});function A({channelId:a}){const e=w.getChannel(a),s=t.storage.deletedMessages?.[a]??[];return r.React.createElement(R,{style:d.container},s.length>0?s.map(function(n,h){return r.React.createElement(r.React.Fragment,{key:n.id+h},r.React.createElement(D,{style:d.logEntry},r.React.createElement(f,{style:d.author},n.author),r.React.createElement(f,{style:d.content},n.content),r.React.createElement(f,{style:d.timestamp},"Deleted at: ",new Date(n.deletedTimestamp).toLocaleString())),r.React.createElement(S,null))}):r.React.createElement(f,{style:d.emptyState},"No deleted messages logged for #",e?.name,"."))}const{TouchableOpacity:H}=u.General;c.findByProps("openLazy","hideActionSheet"),c.findByProps("ActionSheetRow");const L=c.findByProps("push","pop"),b=c.findByStoreName("ChannelStore"),E=2*24*60*60*1e3;t.storage.messageCache??={},t.storage.deletedMessages??={};const i=[];function I(){const a=Date.now();Object.keys(t.storage.messageCache).forEach(function(e){a-t.storage.messageCache[e].timestamp>E&&delete t.storage.messageCache[e]}),Object.keys(t.storage.deletedMessages).forEach(function(e){t.storage.deletedMessages[e]=t.storage.deletedMessages[e].filter(function(s){return a-new Date(s.deletedTimestamp).getTime()<E})})}function v(a){if(!a?.id||!a.content||a.author?.bot)return;const e=t.storage.messageCache[a.id];t.storage.messageCache[a.id]={content:a.content,author:a.author?.username??"unknown",timestamp:Date.now(),editHistory:e?.editHistory??[]}}var F={onLoad:function(){I(),i.push(r.FluxDispatcher.subscribe("MESSAGE_CREATE",function({message:e}){return v(e)})),i.push(r.FluxDispatcher.subscribe("MESSAGE_UPDATE",function({message:e}){const s=t.storage.messageCache[e.id];if(s&&e.content&&s.content!==s.content){const n=s.editHistory??[];n.push({content:s.content,timestamp:s.timestamp}),t.storage.messageCache[e.id]={...s,content:e.content,timestamp:Date.now(),editHistory:n}}})),i.push(r.FluxDispatcher.subscribe("MESSAGE_DELETE",function(e){const s=t.storage.messageCache[e.id];if(s){const{channelId:n}=e;t.storage.deletedMessages[n]??=[],t.storage.deletedMessages[n].unshift({id:e.id,content:s.content,author:s.author,deletedTimestamp:new Date().toISOString()}),t.storage.deletedMessages[n].length>100&&t.storage.deletedMessages[n].pop(),delete t.storage.messageCache[e.id]}}));const a=c.findByName("ChannelHeader",!1);a?i.push(C.after("default",a,function(e,s){o.showToast("ML: CH patch running");const n=e[0]?.channelId;if(!n)return;o.showToast(`ML: CH patch got channelId: ${n}`);const h=b.getChannel(n);if(!h)return;o.showToast(`ML: CH patch got channel: ${h.name}`);const y=t.storage.deletedMessages[n]?.length>0;if(o.showToast(`ML: CH patch hasDeleted: ${y}`),!y)return;const g=T.findInReactTree(s,function(_){return _?.type?.name==="HeaderTitle"});if(!g?.props?.children){o.showToast("ML: CH patch FAILED to find HeaderTitle");return}o.showToast("ML: CH patch found HeaderTitle"),Array.isArray(g.props.children)||(g.props.children=[g.props.children]),g.props.children.push(r.React.createElement(H,{onPress:function(){L.push("VendettaCustomPage",{title:`Deleted Msgs in #${h.name}`,render:function(){return r.React.createElement(A,{channelId:n})}})},style:{marginLeft:8}},r.React.createElement(u.Forms.FormIcon,{source:M.getAssetIDByName("ic_trash_24px")}))),o.showToast("ML: CH patch pushed button")})):p.logger.error("MessageLogger: Could not find ChannelHeader component"),p.logger.log("MessageLogger loaded with UI.")},onUnload:function(){i.forEach(function(a){return a?.()}),i.length=0,p.logger.log("MessageLogger unloaded.")}};return m.default=F,Object.defineProperty(m,"__esModule",{value:!0}),m})({},vendetta.metro.common,vendetta.metro,vendetta.ui.toasts,vendetta,vendetta.plugin,vendetta.patcher,vendetta.utils,vendetta.ui.assets,vendetta.ui.components,vendetta.ui);
