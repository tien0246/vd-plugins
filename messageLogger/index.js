(function(h,a,r,m,u,t,M,R,f,l){"use strict";const{ScrollView:T,View:p,Text:g}=a.ReactNative,{FormRow:F,FormDivider:S}=f.Forms,D=r.findByStoreName("ChannelStore"),c=a.stylesheet.createThemedStyleSheet({container:{flex:1,backgroundColor:l.semanticColors.BACKGROUND_PRIMARY},logEntry:{padding:16},author:{color:l.semanticColors.HEADER_PRIMARY,fontWeight:"bold",marginBottom:4},content:{color:l.semanticColors.TEXT_NORMAL},timestamp:{color:l.semanticColors.TEXT_MUTED,fontSize:12,marginTop:4},emptyState:{color:l.semanticColors.TEXT_MUTED,textAlign:"center",marginTop:20}});function w({channelId:s}){const e=D.getChannel(s),n=t.storage.deletedMessages?.[s]??[];return a.React.createElement(T,{style:c.container},n.length>0?n.map(function(o,i){return a.React.createElement(a.React.Fragment,{key:o.id+i},a.React.createElement(p,{style:c.logEntry},a.React.createElement(g,{style:c.author},o.author),a.React.createElement(g,{style:c.content},o.content),a.React.createElement(g,{style:c.timestamp},"Deleted at: ",new Date(o.deletedTimestamp).toLocaleString())),a.React.createElement(S,null))}):a.React.createElement(g,{style:c.emptyState},"No deleted messages logged for #",e?.name,"."))}const{TouchableOpacity:A,View:b}=f.General;r.findByProps("openLazy","hideActionSheet"),r.findByProps("ActionSheetRow");const E=r.findByProps("push","pop"),I=r.findByStoreName("ChannelStore"),y=2*24*60*60*1e3;t.storage.messageCache??={},t.storage.deletedMessages??={};const d=[];function v(){const s=Date.now();Object.keys(t.storage.messageCache).forEach(function(e){s-t.storage.messageCache[e].timestamp>y&&delete t.storage.messageCache[e]}),Object.keys(t.storage.deletedMessages).forEach(function(e){t.storage.deletedMessages[e]=t.storage.deletedMessages[e].filter(function(n){return s-new Date(n.deletedTimestamp).getTime()<y})})}function L(s){if(!s?.id||!s.content||s.author?.bot)return;const e=t.storage.messageCache[s.id];t.storage.messageCache[s.id]={content:s.content,author:s.author?.username??"unknown",timestamp:Date.now(),editHistory:e?.editHistory??[]}}var _={onLoad:function(){v(),d.push(a.FluxDispatcher.subscribe("MESSAGE_CREATE",function({message:e}){return L(e)})),d.push(a.FluxDispatcher.subscribe("MESSAGE_UPDATE",function({message:e}){const n=t.storage.messageCache[e.id];if(n&&e.content&&n.content!==e.content){const o=n.editHistory??[];o.push({content:n.content,timestamp:n.timestamp}),t.storage.messageCache[e.id]={...n,content:e.content,timestamp:Date.now(),editHistory:o}}})),d.push(a.FluxDispatcher.subscribe("MESSAGE_DELETE",function(e){const n=t.storage.messageCache[e.id];n&&(t.storage.deletedMessages[e.channelId]??=[],t.storage.deletedMessages[e.channelId].unshift({id:e.id,content:n.content,author:n.author,deletedTimestamp:new Date().toISOString()}),t.storage.deletedMessages[e.channelId].length>100&&t.storage.deletedMessages[e.channelId].pop(),delete t.storage.messageCache[e.id])}));const s=r.findByName("ChannelHeader",!1);s?d.push(M.instead("default",s,function(e,n){const o=n(...e),i=e[0]?.channelId;if(!i)return o;const C=I.getChannel(i);if(!C||!(t.storage.deletedMessages[i]?.length>0))return o;const B=a.React.createElement(A,{onPress:function(){if(!E){m.showToast("ML Error: Navigation module not found!");return}m.showToast("ML: Opening deleted messages log..."),E.push("VendettaCustomPage",{title:`Deleted Msgs in #${C.name}`,render:function(){return a.React.createElement(w,{channelId:i})}})},style:{position:"absolute",right:16,top:16,zIndex:1}},a.React.createElement(f.Forms.FormIcon,{source:R.getAssetIDByName("ic_trash_24px")}));return a.React.createElement(b,{style:{flex:1}},o,B)})):u.logger.error("MessageLogger: Could not find ChannelHeader component"),u.logger.log("MessageLogger loaded with UI.")},onUnload:function(){d.forEach(function(s){return s?.()}),d.length=0,u.logger.log("MessageLogger unloaded.")}};return h.default=_,Object.defineProperty(h,"__esModule",{value:!0}),h})({},vendetta.metro.common,vendetta.metro,vendetta.ui.toasts,vendetta,vendetta.plugin,vendetta.patcher,vendetta.ui.assets,vendetta.ui.components,vendetta.ui);
