(function(i,n,c,h,g,t,y,C,l){"use strict";const{View:M,Text:u}=n.ReactNative;function b({channelId:s}){return n.React.createElement(M,{style:{flex:1,backgroundColor:"#1E1F22",justifyContent:"center",alignItems:"center"}},n.React.createElement(u,{style:{color:"white",fontSize:18,fontWeight:"bold"}},"Hello from DeletedMessagesLog!"),n.React.createElement(u,{style:{color:"white",marginTop:8}},"Channel ID: ",s))}const{TouchableOpacity:p,View:w}=l.General;c.findByProps("openLazy","hideActionSheet"),c.findByProps("ActionSheetRow");const f=c.findByProps("push","pop"),I=c.findByStoreName("ChannelStore"),m=2*24*60*60*1e3;t.storage.messageCache??={},t.storage.deletedMessages??={};const o=[];function D(){const s=Date.now();Object.keys(t.storage.messageCache).forEach(function(e){s-t.storage.messageCache[e].timestamp>m&&delete t.storage.messageCache[e]}),Object.keys(t.storage.deletedMessages).forEach(function(e){t.storage.deletedMessages[e]=t.storage.deletedMessages[e].filter(function(a){return s-new Date(a.deletedTimestamp).getTime()<m})})}function S(s){if(!s?.id||!s.content||s.author?.bot)return;const e=t.storage.messageCache[s.id];t.storage.messageCache[s.id]={content:s.content,author:s.author?.username??"unknown",timestamp:Date.now(),editHistory:e?.editHistory??[]}}var T={onLoad:function(){D(),o.push(n.FluxDispatcher.subscribe("MESSAGE_CREATE",function({message:e}){return S(e)})),o.push(n.FluxDispatcher.subscribe("MESSAGE_UPDATE",function({message:e}){const a=t.storage.messageCache[e.id];if(a&&e.content&&a.content!==e.content){const r=a.editHistory??[];r.push({content:a.content,timestamp:a.timestamp}),t.storage.messageCache[e.id]={...a,content:e.content,timestamp:Date.now(),editHistory:r}}})),o.push(n.FluxDispatcher.subscribe("MESSAGE_DELETE",function(e){const a=t.storage.messageCache[e.id];a&&(t.storage.deletedMessages[e.channelId]??=[],t.storage.deletedMessages[e.channelId].unshift({id:e.id,content:a.content,author:a.author,deletedTimestamp:new Date().toISOString()}),t.storage.deletedMessages[e.channelId].length>100&&t.storage.deletedMessages[e.channelId].pop(),delete t.storage.messageCache[e.id])}));const s=c.findByName("ChannelHeader",!1);s?o.push(y.instead("default",s,function(e,a){const r=a(...e),d=e[0]?.channelId;if(!d)return r;const E=I.getChannel(d);if(!E||!(t.storage.deletedMessages[d]?.length>0))return r;const v=n.React.createElement(p,{onPress:function(){if(!f){h.showToast("ML Error: Navigation module not found!");return}h.showToast("ML: Opening deleted messages log..."),f.push("VendettaCustomPage",{title:`Deleted Msgs in #${E.name}`,render:function(){return n.React.createElement(b,{channelId:d})}})},style:{position:"absolute",right:16,top:16,zIndex:1}},n.React.createElement(l.Forms.FormIcon,{source:C.getAssetIDByName("ic_trash_24px")}));return n.React.createElement(w,{style:{flex:1}},r,v)})):g.logger.error("MessageLogger: Could not find ChannelHeader component"),g.logger.log("MessageLogger loaded with UI.")},onUnload:function(){o.forEach(function(s){return s?.()}),o.length=0,g.logger.log("MessageLogger unloaded.")}};return i.default=T,Object.defineProperty(i,"__esModule",{value:!0}),i})({},vendetta.metro.common,vendetta.metro,vendetta.ui.toasts,vendetta,vendetta.plugin,vendetta.patcher,vendetta.ui.assets,vendetta.ui.components);
